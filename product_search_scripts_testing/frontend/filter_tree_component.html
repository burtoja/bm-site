<!--
============================================================
Boilers & Machinery — Filter Tree Component

This is the template file for the filter tree of
categories and subcategories loaded from the DB.

Date: Sept 2025

============================================================
-->

<style>
    .bm-tree { font-size: 13px; line-height: 1.2; }
    .bm-tree ul { margin-left: .5rem; border-left: 1px solid #e5e7eb; }
    .bm-tree li { position: relative; padding-left: .55rem; }
    .bm-tree li::before { content: ""; position: absolute; left: -1px; top: .85rem; width: .55rem; border-top: 1px solid #e5e7eb; }
    .bm-tree > li::before { content: none !important;}  /* Remove connector line only for top-level categories */
    .bm-hit { width: 1.05rem; height: 1.05rem; display: inline-grid; place-items: center; border: 1px solid #94a3b8; border-radius: 3px; font-size: 11px; line-height: 1; background: #0f172a0a; }
    .bm-hit[aria-expanded="true"]{ background:red; }
    .bm-node { color:#e5e7eb; }
    .bm-node:hover { text-decoration: underline; }
    .bm-active { font-weight: 600; color:#38bdf8; }


</style>

<div x-data="filterTree()" x-init="init()" class="space-y-3 max-w-3xl text-white">

    <!-- SECTION - Search Button -->
    <div id="search-button-wrapper" class="sticky top-4 z-20 space-y-3">
        <button @click="submitFilters()"
                :disabled="isLoadingFilters"
                class="search-submit px-4 py-2 rounded font-semibold">
            Search Products
        </button>

        <!-- SECTION - Selected Summary (Breadcrumb) -->
        <div x-show="hasAnySelection()" class="bg-slate-800/60 border border-slate-600 rounded-xl p-3 space-y-2">
            <!-- Breadcrumb -->
            <div class="text-sm text-slate-200 flex flex-wrap items-center gap-1">
                <span class="font-semibold">Selected:</span>
                <template x-if="breadcrumb().length">
                      <span class="flex flex-wrap items-center gap-1">
                            <template x-for="(crumb, i) in breadcrumb()" :key="i">
                                  <span class="flex items-center gap-1">
                                        <span x-text="crumb"></span>
                                        <span x-show="i < breadcrumb().length - 1" class="opacity-60">›</span>
                                  </span>
                            </template>
                      </span>
                </template>
            </div>

            <!-- Selected filter chips, grouped by filter -->
            <div class="flex flex-wrap gap-2">
                <template x-for="group in groupedSelections()" :key="group.name">
                    <div class="bg-slate-700/70 border border-slate-500 rounded-lg p-2">
                        <div class="text-xs font-semibold mb-1" x-text="group.name"></div>
                        <div class="flex flex-wrap gap-1.5">
                            <template x-for="opt in group.options" :key="opt.id">
                                <button
                                        @click="removeOption(opt.id)"
                                        class="chip-btn">
                                    <span x-text="opt.value"></span> ×
                                </button>
                            </template>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Footer: Clear all on its own line at the bottom -->
            <div class="pt-2 mt-1 flex justify-end border-t border-slate-600/40">
                <button type="button" @click="clearAll()" class="clear-btn">
                    Clear all
                </button>
            </div>
        </div>
    </div>




    <ul class="bm-tree text-white space-y-1" role="tree">
        <!-- SECTION 1 - Categories and category filters -->
        <template x-for="category in categories" :key="category.id">
            <li role="treeitem" :aria-expanded="category.open">
                <div class="flex items-start gap-1.5">
                    <button class="bm-hit shrink-0"
                            @click="
                                setCategoryPath({
                                  categoryId: category.id, categoryName: category.name,
                                  subcategoryId: null, subcategoryName: null,
                                  subsubcategoryId: null, subsubcategoryName: null
                                });
                                //onSelectionChange();          // keeps URL in sync
                                toggleCategory(category);
                              "
                            :aria-expanded="category.open">
                        <span x-text="category.open ? '-' : '+'"></span>
                    </button>
                    <button type="button" @click="
                                  setCategoryPath({
                                      categoryId: category.id, categoryName: category.name,
                                      subcategoryId: null, subcategoryName: null,
                                      subsubcategoryId: null, subsubcategoryName: null
                                    });
                                  //onSelectionChange();            // writes cat_id to URL & runs search
                                  toggleCategory(category);       // (optional) also open/close it
                                "
                            class="bm-node text-left"
                            :class="(selectedCategoryId === category.id && category.open) ? 'bm-active' : ''">
                        <span x-text="category.name"></span>
                    </button>
                </div>

                <template x-if="category.open">
                    <ul class="ml-2 mt-1 space-y-[2px]" role="group">

                        <!-- CATEGORY-LEVEL FILTERS AS PEER BRANCHES -->
                        <template x-for="(filter, i) in category.filters || []" :key="filter.id || i">
                            <li role="treeitem" :aria-expanded="filter.open">
                                <div class="flex items-start gap-1.5">
                                    <button class="bm-hit shrink-0" @click="filter.open = !filter.open" :aria-expanded="filter.open">
                                        <span x-text="filter.open ? '–' : '+'"></span>
                                    </button>
                                    <button @click="filter.open = !filter.open" class="bm-node text-left">
                                        <span x-text="filter.name"></span>
                                    </button>
                                </div>
                                <template x-if="filter.open">
                                    <ul class="ml-2 mt-1 space-y-[2px]" role="group">
                                        <template x-for="opt in filter.options" :key="opt.id">
                                            <li>
                                                <div class="flex items-start gap-1.5">
                                                    <!--<span class="bm-hit shrink-0 opacity-30">•</span>-->
                                                    <label class="flex items-center gap-2">
                                                        <input
                                                                type="checkbox"
                                                                :checked="isChecked(filter.name, opt.value)"
                                                                @change="
                                                                    if (!selected.categoryPath.categoryId) {
                                                                      setCategoryPath({
                                                                        categoryId: category.id, categoryName: category.name,
                                                                        subcategoryId: (typeof subcat !== 'undefined' ? subcat.id : null),
                                                                        subcategoryName: (typeof subcat !== 'undefined' ? subcat.name : null),
                                                                        subsubcategoryId: (typeof subsub !== 'undefined' ? subsub.id : null),
                                                                        subsubcategoryName: (typeof subsub !== 'undefined' ? subsub.name : null)
                                                                      });
                                                                    }
                                                                    toggleFilter(filter.name, opt.value, $event.target.checked);
                                                                    onSelectionChange();
                                                                  "
                                                                class="shrink-0"
                                                        />
                                                        <span class="truncate" :title="opt.value" x-text="opt.value"></span>
                                                    </label>
                                                </div>
                                            </li>
                                        </template>
                                    </ul>
                                </template>
                            </li>
                        </template>

                        <!-- SECTION 2 - Subcategory and subcategory filters -->
                        <template x-for="subcat in category.subcategories" :key="subcat.id">
                            <li role="treeitem" :aria-expanded="subcat.open">
                                <div class="flex items-start gap-1.5">
                                    <button class="bm-hit shrink-0"
                                            @click="
                                                subcat.open = !subcat.open;
                                                setActiveBranch(subcat);
                                                setCategoryPath({
                                                  categoryId: category.id, categoryName: category.name,
                                                  subcategoryId: subcat.id,  subcategoryName: subcat.name,
                                                  subsubcategoryId: null,    subsubcategoryName: null
                                                });
                                                onSelectionChange();
                                                if (subcat.open && !subcat.loaded) loadSubcategoryFilters(subcat);
                                              "
                                            :aria-expanded="subcat.open">
                                        <span x-text="subcat.open ? '–' : '+'"></span>
                                    </button>
                                    <button type="button"
                                            @click="
                                                setCategoryPath({
                                                  categoryId: category.id,     categoryName: category.name,
                                                  subcategoryId: subcat.id,    subcategoryName: subcat.name,
                                                  subsubcategoryId: null,      subsubcategoryName: null
                                                });
                                                subcat.open = !subcat.open;
                                                onSelectionChange();
                                              "
                                            class="bm-node text-left"
                                            :class="subcat.open ? 'bm-active' : ''">
                                        <span x-text="subcat.name"></span>
                                    </button>

                                </div>

                                <template x-if="subcat.open">
                                    <ul class="ml-2 mt-1 space-y-[2px]" role="group">
                                        <!-- Loading leaf -->
                                        <li x-show="subcat.loading">
                                            <div class="flex items-start gap-1.5">
                                                <!--<span class="bm-hit shrink-0 opacity-30">•</span>-->
                                                <span class="text-xs text-gray-300">Loading…</span>
                                            </div>
                                        </li>

                                        <!-- SUBCATEGORY FILTERS AS PEER BRANCHES -->
                                        <template x-for="(filter, i) in subcat.filters || []" :key="filter.id || i">
                                            <li role="treeitem" :aria-expanded="filter.open">
                                                <div class="flex items-start gap-1.5">
                                                    <button class="bm-hit shrink-0"
                                                            @click="filter.open = !filter.open"
                                                            :aria-expanded="filter.open">
                                                        <span x-text="filter.open ? '–' : '+'"></span>
                                                    </button>
                                                    <button @click="filter.open = !filter.open" class="bm-node text-left">
                                                        <span x-text="filter.name"></span>
                                                    </button>
                                                </div>

                                                <template x-if="filter.open">
                                                    <ul class="ml-2 mt-1 space-y-[2px]" role="group">
                                                        <template x-for="opt in filter.options" :key="opt.id">
                                                            <li>
                                                                <div class="flex items-start gap-1.5">
                                                                    <!--<span class="bm-hit shrink-0 opacity-30">•</span>-->
                                                                    <label class="flex items-center gap-2">
                                                                        <input
                                                                                type="checkbox"
                                                                                :checked="isChecked(filter.name, opt.value)"
                                                                                @change="
                                                                                    if (!selected.categoryPath.categoryId) {
                                                                                      setCategoryPath({
                                                                                        categoryId: category.id, categoryName: category.name,
                                                                                        subcategoryId: subcat.id, subcategoryName: subcat.name,
                                                                                        subsubcategoryId: (typeof subsub !== 'undefined' ? subsub.id : null),
                                                                                        subsubcategoryName: (typeof subsub !== 'undefined' ? subsub.name : null)
                                                                                      });
                                                                                    }
                                                                                    toggleFilter(filter.name, opt.value, $event.target.checked);
                                                                                    onSelectionChange();
                                                                                  "
                                                                                class="shrink-0"
                                                                        />
                                                                        <span class="truncate" :title="opt.value" x-text="opt.value"></span>
                                                                    </label>
                                                                </div>
                                                            </li>
                                                        </template>
                                                    </ul>
                                                </template>
                                            </li>
                                        </template>

                                        <!-- No-filters leaf (only when no filters AND no sub-subcategories, after load) -->
                                        <li x-show="
                                                        !subcat.loading
                                                        && subcat.loaded
                                                        && !(subcat.filters && subcat.filters.length)
                                                        && !(subcat.subcategories && subcat.subcategories.length)
                                                    ">
                                            <div class="flex items-start gap-1.5">
                                                <!--<span class="bm-hit shrink-0 opacity-30">•</span>-->
                                                <span class="text-xs text-gray-400">(No filters for this subcategory)</span>
                                            </div>
                                        </li>

                                        <!-- SECTION 3 - Sub-subcategories and filters -->
                                        <template x-for="subsub in subcat.subcategories" :key="subsub.id">
                                            <li role="treeitem" :aria-expanded="subsub.open">
                                                <div class="flex items-start gap-1.5">
                                                    <button class="bm-hit shrink-0"
                                                            @click="
                                                                subsub.open = !subsub.open;
                                                                setActiveBranch(subcat, subsub);
                                                                setCategoryPath({
                                                                  categoryId: category.id, categoryName: category.name,
                                                                  subcategoryId: subcat.id, subcategoryName: subcat.name,
                                                                  subsubcategoryId: subsub.id, subsubcategoryName: subsub.name
                                                                });
                                                                onSelectionChange();
                                                                if (subsub.open && !subsub.loaded) loadSubcategoryFilters(subsub, 'subsub');
                                                              "
                                                            :aria-expanded="subsub.open">
                                                        <span x-text="subsub.open ? '–' : '+'"></span>
                                                    </button>
                                                    <button type="button"
                                                            @click="
                                                                setCategoryPath({
                                                                  categoryId: category.id,     categoryName: category.name,
                                                                  subcategoryId: subcat.id,    subcategoryName: subcat.name,
                                                                  subsubcategoryId: subsub.id, subsubcategoryName: subsub.name
                                                                });
                                                                onSelectionChange();
                                                              "
                                                            class="bm-node text-left"
                                                            :class="subsub.open ? 'bm-active' : ''">
                                                        <span x-text="subsub.name"></span>
                                                    </button>

                                                </div>

                                                <template x-if="subsub.open">
                                                    <ul class="ml-2 mt-1 space-y-[2px]" role="group">
                                                        <!-- Loading leaf -->
                                                        <li x-show="subsub.loading">
                                                            <div class="flex items-start gap-1.5">
                                                                <!--<span class="bm-hit shrink-0 opacity-30">•</span>-->
                                                                <span class="text-xs text-gray-300">Loading…</span>
                                                            </div>
                                                        </li>

                                                        <!-- SUB-SUBCATEGORY FILTERS -->
                                                        <template x-for="(filter, i) in subsub.filters || []" :key="filter.id || i">
                                                            <li role="treeitem" :aria-expanded="filter.open">
                                                                <div class="flex items-start gap-1.5">
                                                                    <button class="bm-hit shrink-0"
                                                                            @click="filter.open = !filter.open"
                                                                            :aria-expanded="filter.open">
                                                                        <span x-text="filter.open ? '–' : '+'"></span>
                                                                    </button>
                                                                    <button @click="
                                                                                    setCategoryPath({ categoryId: rootCat.id, subcategoryId: sub.id, subsubcategoryId: filter.id });
                                                                                    setCategoryPath({
                                                                                      categoryId: category.id, categoryName: category.name,
                                                                                      subcategoryId: sub.id, subcategoryName: sub.name,
                                                                                      subsubcategoryId: subsub.id, subsubcategoryName: subsub.name
                                                                                    });
                                                                                    onSelectionChange()
                                                                                   "
                                                                            class="bm-node text-left"
                                                                    >
                                                                        <span x-text="filter.name"></span>
                                                                    </button>
                                                                </div>

                                                                <template x-if="filter.open">
                                                                    <ul class="ml-2 mt-1 space-y-[2px]" role="group">
                                                                        <template x-for="opt in filter.options" :key="opt.id">
                                                                            <li>
                                                                                <div class="flex items-start gap-1.5">
                                                                                    <!--<span class="bm-hit shrink-0 opacity-30">•</span>-->
                                                                                    <label class="flex items-center gap-2">
                                                                                        <input
                                                                                                type="checkbox"
                                                                                                :checked="isChecked(filter.name, opt.value)"
                                                                                                @change="
                                                                                                    if (!selected.categoryPath.categoryId) {
                                                                                                      setCategoryPath({
                                                                                                        categoryId: category.id, categoryName: category.name,
                                                                                                        subcategoryId: subcat.id, subcategoryName: subcat.name,
                                                                                                        subsubcategoryId: subsub.id, subsubcategoryName: subsub.name
                                                                                                      });
                                                                                                    }
                                                                                                    toggleFilter(filter.name, opt.value, $event.target.checked);
                                                                                                    onSelectionChange();
                                                                                                  "
                                                                                                class="shrink-0"
                                                                                        />
                                                                                        <span class="truncate" :title="opt.value" x-text="opt.value"></span>
                                                                                    </label>
                                                                                </div>
                                                                            </li>
                                                                        </template>
                                                                    </ul>
                                                                </template>
                                                            </li>
                                                        </template>

                                                        <!-- No-filters leaf -->
                                                        <li x-show="!subsub.loading && (!subsub.filters || !subsub.filters.length)">
                                                            <div class="flex items-start gap-1.5">
                                                                <!--<span class="bm-hit shrink-0 opacity-30">•</span>-->
                                                                <span class="text-xs text-gray-400">(No filters for this subcategory)</span>
                                                            </div>
                                                        </li>
                                                    </ul>
                                                </template>
                                            </li>
                                        </template>



                                    </ul>
                                </template>
                            </li>
                        </template>
                    </ul>
                </template>
            </li>
        </template>
    </ul>
</div>
